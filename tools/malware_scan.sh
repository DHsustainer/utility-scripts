#!/bin/bash

echo "============================================================"
echo "                                                            "
echo "                      Malware Scanner                       "
echo "                                                            "
echo "============================================================"

function show_help {
    echo "Usage: $0 -d <directory_to_scan> -l <log_file>"
    echo ""
    echo "Options:"
    echo "  -d  Directory to scan"
    echo "  -l  Log file where the results of the scan will be saved"
}

DIR=""
LOG_FILE=""

while getopts ":d:l:h" opt; do
    case $opt in
    d)
        DIR="$OPTARG"
        ;;
    l)
        LOG_FILE="$OPTARG"
        ;;
    h)
        show_help
        exit 0
        ;;
    \?)
        echo "Invalid option -$OPTARG" >&2
        show_help
        exit 1
        ;;
    :)
        echo "The -$OPTARG option requires an argument." >&2
        show_help
        exit 1
        ;;
    esac
done

if [ -z "$DIR" ] || [ -z "$LOG_FILE" ]; then
    echo "You must specify both the directory and the log file."
    show_help
    exit 1
fi

if [ ! -d "$DIR" ]; then
    echo "The specified directory does not exist: $DIR"
    exit 1
fi

DATE=$(date +"%Y-%m-%d %H:%M:%S")

echo "Starting scan on $DIR at $DATE" | tee -a "$LOG_FILE"

clamscan -r -i "$DIR" | tee -a "$LOG_FILE"

if [ $? -eq 0 ]; then
    echo "Scan completed. No threats found." | tee -a "$LOG_FILE"
else
    echo "Scan completed. Threats were found. Check the log for more details." | tee -a "$LOG_FILE"
fi

DATE=$(date +"%Y-%m-%d %H:%M:%S")
echo "Scanning completed at $DATE" | tee -a "$LOG_FILE"
